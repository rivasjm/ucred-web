name: Deploy to WebDAV

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: ðŸ§¹ Validar HTML
        run: |
          # Simple HTML validation - check for basic structure
          if grep -q "<!DOCTYPE html>" index.html && \
             grep -q "<html" index.html && \
             grep -q "</html>" index.html; then
            echo "âœ… HTML structure is valid"
          else
            echo "âŒ HTML structure is invalid"
            exit 1
          fi

      - name: ðŸŽ¨ Validar CSS existe
        run: |
          if [ -f "css/styles.css" ]; then
            echo "âœ… CSS file found"
          else
            echo "âŒ CSS file not found"
            exit 1
          fi

      - name: ðŸ”§ Validar JavaScript
        run: |
          # Check all JS files exist
          for file in js/calculator.js js/history.js js/theme.js js/main.js; do
            if [ -f "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âŒ Missing $file"
              exit 1
            fi
          done

      - name: ðŸš€ Deploy a WebDAV
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          chmod +x deploy.sh
          ./deploy.sh

      - name: ðŸ“Š Resumen de Deployment
        run: |
          echo "## ðŸŽ‰ Deployment Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Archivos desplegados en /calculadora:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… index.html" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… css/styles.css" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… js/calculator.js" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… js/history.js" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… js/theme.js" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… js/main.js" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL de acceso:** https://usuario.unican.es/calculadora/" >> $GITHUB_STEP_SUMMARY
